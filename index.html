<!DOCTYPE HTML>

<html>
    <head>
        <link rel="stylesheet" type="text/css" href="e2e.css">		
    </head>
   
    <body>
        <script src="./e2e.js" type="text/javascript">
        </script>


        <div id="main">
            <img id="logo" src="image/Logo_ArmPelion_White.bc9f68a5a605.svg"/>

            <h1>Device Communication with Pelion Device Management Service API</h1>

            <h2>API key</h2>
            <p>
                Please input your API key here. (API key starts from ak_...)
                <div>
                    <input id="apikey" type="text" size="80" value="" placeholder="ak_..."/>
                </div>
            </p>

            <h2>Open event notification channel and receive event from device</h2>
            <p>
                To use the WebSocket channel, follow these steps. Detailed description on this flow is
                <a href="https://www.pelion.com/docs/device-management/current/integrate-web-app/event-notification.html#websocket-interface">here</a>.
                Note that you can open only 1 notification channel per API key.
            </p>

            <h3>Create WebSocket notification channel</h3>
            <p>
                First we will need to open a <a href="https://www.pelion.com/docs/device-management/current/integrate-web-app/event-notification.html">Event notification channel.</a>
                Click this button to create a WebSocket notification channel with 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#registerWebsocket">PUT /v2/notification/websocket</a>.
                <div>
                    <button type="button" onclick="createWebSocketNotificationChannel()"> Create websocket notification channel</button>
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L1-L17">Code</a>
                </div>
            </p>
            
            <h3>Connect WebSocket notification channel</h3>
            <p>
                After creating your WebSocket notification channel, connect to it with
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#connectWebsocket">GET /v2/websocket-connect</a>.
                <div>
                    <button type="button" onclick="connectWebSocket()"> Open WebSocket to the channel</button>
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L19-L89">Code</a>
                </div>
            </p>
            <p>
                Now you have a event notification channel open. You will receive the device lifitime events (Register, Register-Update and Expire) by default.
            </p>

            <h2>Connect your device</h2>
            <p>
                Turn on your device and connect to Pelion.
                You should see <b>reqistration</b> or <b>reg-update</b> event in the <b>Notification Channel</b> below.
            </p>
            <h3>Choose your device</h3>
            <p>
                First, click <b>Get Registered Devices</b> button below to get the devices which state is <b>registered</b>.
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-directory.html#deviceList">GET /v3/devices</a> is used to get device list.
                <div>
                    <button type="button" onclick="getRegisteredDevices()">Get Registered Devices</button> 
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L91-L113">Code</a>
                    <br />
                    <select id="deviceSelector">
                        <option value="00000000000000000000000000000000">Click the above button to get registered devices</option>
                    </select>
                </div>
            </p>

            <h2>Write resource to device</h2>
            <p>
                Send a resource update request to a device with 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#createAsyncRequest">POST /v2/device-requests</a>.
                For detail flow, see <a href="https://www.pelion.com/docs/device-management/current/connecting/handle-resource-webapp.html#the-write-operation">the Write operation</a>.
            </p>
            <p>
                With Write request you can configure the device. The example application blinks a LED, let's configure new blink pattern by writing it in "pattern_resource" /3201/0/5853.
                The default value of this resource is "500:500:500:500". We change this to "500:1000:500:1000". This value must be encoded into Base64, which is done in our script.
                <div>
                    Pattern: <input id="blinkPattern" type="text" size="30" value="500:1000:500:1000" /><br />
                    <button type="button" onClick="writeResource( getDeviceId(), '/3201/0/5853', document.getElementById('blinkPattern').value)">Write resource to "pattern_resource" (/3201/0/5853)</button>
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L115-L133">Code</a>
                </div>
            </p>
            <p>
                You'll get an async-response on your notification channel when the device accepted the request. In addition, the user LED on the device will blink with the specified pattern, 500 ms, 1000 ms, 500 ms, 1000 ms.
            </p>
            
            <h2>Read resource from device</h2>
            <p>
                Send a resource read request to a device with 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#createAsyncRequest">POST /v2/device-requests</a>.
                For detail flow, see <a href="https://www.pelion.com/docs/device-management/current/connecting/handle-resource-webapp.html#the-read-operation">the Read operation</a>.
            </p>
            <p>
                For example, let's read resource Digital Input Counter /3200/0/5501.
                <div>
                    <button type="button" onClick="readResource( getDeviceId(), '/3200/0/5501')">Read resource Digital Input Counter (/3200/0/5501)</button>
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L135-L152">Code</a>
                </div>
            </p>
            <h3>Note for cache</h3>
            <p>
                If max-age value is set by the device's client, reported values from the device is cached for max-age:
                <a href="https://www.pelion.com/docs/device-management/current/connecting/device-guidelines.html#resource-cache">https://www.pelion.com/docs/device-management/current/connecting/device-guidelines.html#resource-cache</a>
                If the cached value is valid, it will be returned as the response. If your webapp needs to get the current value from the device, not cached value, max-age must be set 0 (default is 0) at the client.
            </p>

            <h2>Subscribe resource</h2>
            <p>
                Subscribe to a resource on a device with 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#addResourceSubscription">PUT /v2/subscription/{device-id}/{resourcePath}</a>.
            </p>
            <p>
                For example, let's subscribe Digital Input Counter /3200/0/5501 resource.
                <div>
                    <button type="button" onClick="subscribeResource( getDeviceId(), '/3200/0/5501')">Subscribe to Digital Input Counter (/3200/0/5501)</button>
                </div>
                You will receive an async response and followed by notifications for resource change. 
            </p>
            <p>
                To stop subscribing to the resource, use 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#deleteResourceSubscription">DELETE /v2/subscriptions/{device-id}/{resourcePath}</a>.
                <div>
                    <button type="button" onClick="unsubscribeResource( getDeviceId(), '/3200/0/5501')">Unsubscribe to Digital Input Counter (/3200/0/5501)</button>
                    <a href="https://github.com/coisme/Pelion-device-e2e-example/blob/541abb7ce1ddaef5ef3508e52bad9a8beaa37e8c/e2e.js#L154-L168">Code</a>
                </div>
            </p>

            <h2>Presubscribe resource</h2>
            <p>
                Presubscribe to a resource with <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#updatePreSubscriptions">PUT /v2/subscriptions</a>.
            </p>
            <p>
                A presubscription automatically subscribes to Resources based on given rules. 
                When a device with Resources match the set rules, the Device management Connect service sends a subscription (observe) request to the device on behalf of your application.
                See 
                <a href="https://www.pelion.com/docs/device-management/current/connecting/resource-change-webapp.html#presubscriptions">this online document</a>
                for details of presubscription.
            </p>
            <p>
                Let's presubscribe to Digital Input Counter /3200/0/5501. 
                To presubscribe, use <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#updatePreSubscriptions">PUT /v2/subscriptions</a>.
                This case, any device which has Digital Input Counter /3200/0/5501 resource will be subscribed automatically
                when device registers or does register update.
                <div>
                    <button type="button" onClick="presubscribe( getDeviceId(), '/3200/0/5501')">Presubscribe /3200/0/5501 on the selected device</button>
                </div>
            </p>
            <p>
                Try to reboot your device. The resource /3200/0/5501 will be subscribed automatically and you'll see notification on your notification channel.
            </p>
            <p>
                To unsubscribe presubscription, use <a href="">DELETE /v2/subscriptions</a>.
                <div>
                    <button type="button" onClick="unpresubscribe()">Unsubscribe presubscription</button>
                </div>
            </p>

            <h2>Set notification rules for a resource</h2>
            <p>
                The web application can set a rule-based subscription to an Object, an Object Instance or a Resource.
            </p>
            <p>
                The device updates Digital Input Counter /3200/0/5501 every 5 seconds and is reported to Pelion Device Management.
                However, your webapp may need data only every 1 minutes and not want to receive redundant data.
                In this case, you can use  the notification rule pmin, which sets minimum report period.
                Details for notification rules, see 
                <a href="https://www.pelion.com/docs/device-management/current/connecting/resource-change-webapp.html#notification-rules">this page</a>.
            </p>
            <p>
                To set pmin 1 minute to your subscription to Digital Input Counter /3200/0/5501, set tMin with 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#createAsyncRequest">POST /v2/device-request</a>.
                Specify the resource path in uri field with pmin=60 parameter. This is done in the script. 
                <div>
                    <button type="button" onClick="setFilterParameter( getDeviceId(), '/3200/0/5501', 'pmin=60')">Set pmin=60 to /3200/0/5501 on the selected device</button>
                </div>
            </p>
            
            <h2>Delete WebSocket notification channel</h2>
            <p>
                In the end, delete the WebSocket notification channel bound to the API key. This is required to change the channel from websocket to another type.
                <div>
                    <button type="button" onClick="deleteWebSocketNotificationChannel()">Delete WebSocket notification channel</button>
                </div>
            </p>
        </div>

        <div id="logs">
            <div class="terminal-container">
                <b>Events</b>
                <div id="event_log" class="terminal"></div>
            </div>
            <div class="terminal-container">
                    <b>Notification Channel</b>
                    <div id="notification_channel" class="terminal"></div>
            </div>
            <div class="terminal-container">
                <b>Device Events</b>
                <div id="device_data_events" class="terminal"></div>
            </div>
        </div>
        
    </body>
</html>
